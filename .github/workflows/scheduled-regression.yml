name: CD - Nightly Regression

on:
  schedule:
    # Runs at 15:00 UTC, which is 02:00 AM Sydney (AEDT)
    - cron: '0 15 * * *'
  workflow_dispatch: # Allows manual trigger for major releases

jobs:
  regression-tests:
    runs-on: ubuntu-latest
    env:
      LOGIN_USER: ${{ secrets.APP_USERNAME }}
      LOGIN_PASS: ${{ secrets.APP_PASSWORD }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Regression Tests with Retry Logic
        run: |
          # Ensure a clean directory structure for regression results
          mkdir -p results/regression
          mkdir -p results/regression/rerun
          
          echo "Starting First Attempt of Full Regression..."
          # First Attempt
          robot --variable browser_name:headlesschrome \
                --variable user:$LOGIN_USER \
                --variable pass:$LOGIN_PASS \
                --include regression \
                --outputdir results/regression \
                tests/ || true
          
          # Check if first attempt had failures
          if [ -f results/regression/output.xml ]; then
            if grep -q 'fail="[1-9]' results/regression/output.xml; then
              echo "Failures detected in regression suite. Starting Rerun..."
               
              # Rerun only failed tests
              robot --rerunfailed results/regression/output.xml \
                    --variable browser_name:headlesschrome \
                    --variable user:$LOGIN_USER \
                    --variable pass:$LOGIN_PASS \
                    --outputdir results/regression/rerun \
                    tests/ || true
                 
              # Merge results so the nightly report is unified
              echo "Merging regression results..."
              rebot --merge --outputdir results/regression results/regression/output.xml results/regression/rerun/output.xml || true
            else
              echo "All regression tests passed on first attempt."
            fi
          else
            echo "Robot Framework failed to generate regression output.xml."
            exit 1
          fi

      - name: Upload Regression Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-test-results
          path: results/regression/
          retention-days: 14 # Keeping regression logs longer for deeper debugging