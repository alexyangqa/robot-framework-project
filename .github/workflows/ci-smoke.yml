name: CI - Smoke Suite

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allows manual run for a quick check

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    env:
      # This maps the GitHub Secret to a temporary environment variable
      LOGIN_USER: ${{ secrets.APP_USERNAME }}
      LOGIN_PASS: ${{ secrets.APP_PASSWORD }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Smoke Tests with Retry Logic
        run: |
          # Ensure a clean directory structure for results
          mkdir -p results/smoke
          mkdir -p results/smoke/rerun
          
          echo "Starting First Attempt..."
          # First Attempt
          robot --variable browser_name:headlesschrome \
                --variable user:$LOGIN_USER \
                --variable pass:$LOGIN_PASS \
                --include smoke \
                --outputdir results/smoke \
                tests/ || true
          
          # Check if first attempt had failures by looking at output.xml
          if [ -f results/smoke/output.xml ]; then
              # Check if there are failures before attempting rerun
              if grep -q 'fail="[1-9]' results/smoke/output.xml; then
                 echo "Failures detected, attempting rerun..."
          
                 # Rerun only failed tests
                 robot --rerunfailed results/smoke/output.xml \
                       --variable browser_name:headlesschrome \
                       --variable user:$LOGIN_USER \
                       --variable pass:$LOGIN_PASS \
                       --outputdir results/smoke/rerun \
                       tests/ || true
          
                 # Merge results so the final report is unified
                 echo "Merging results..."
                 rebot --merge --outputdir results/smoke results/smoke/output.xml results/smoke/rerun/output.xml || true
              else
                 echo "All tests passed on first attempt."
              fi
          else
              echo "Robot Framework failed to generate output.xml. Check your test paths."
              exit 1
          fi

      - name: Upload Smoke Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: results/smoke/
          retention-days: 7